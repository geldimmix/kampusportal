name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pgsql, pdo_pgsql, mbstring, xml, curl, zip, gd, intl, bcmath

      - name: Validate composer.json (if exists)
        run: |
          if [ -f composer.json ]; then
            composer validate --strict
          fi

      - name: Install dependencies (if composer.json exists)
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-dev --optimize-autoloader
          fi

      - name: Run tests (if phpunit.xml exists)
        run: |
          if [ -f phpunit.xml ]; then
            vendor/bin/phpunit --no-coverage
          fi

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/askida-destek
            
            # Pull latest changes
            git fetch origin main
            git reset --hard origin/main
            
            # Install/update dependencies if composer exists
            if [ -f composer.json ]; then
              composer install --prefer-dist --no-progress --no-dev --optimize-autoloader
            fi
            
            # Clear cache (if applicable)
            if [ -d cache ]; then
              rm -rf cache/*
            fi
            
            # Set permissions
            chown -R www-data:www-data /var/www/askida-destek
            chmod -R 755 /var/www/askida-destek
            
            # Restart PHP-FPM (if using FPM)
            # systemctl restart php8.3-fpm
            
            # Reload Apache
            systemctl reload apache2
            
            echo "‚úÖ Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üöÄ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

